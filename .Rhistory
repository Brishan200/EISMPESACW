group_by(functional_type) %>%
reframe(tot = sum(total_cells))
ays_data %>%
distinct(site, tow_size, tow_type, taxon) %>%
group_by(site, tow_size, tow_type) %>%
summarise(n_taxa = n_distinct(taxon), .groups = 'drop') %>%
pivot_wider(names_from = c(tow_size,tow_type),
values_from = n_taxa)
ays_data %>%
distinct(site, tow_size, tow_type,genus, taxon) %>%
group_by(site, tow_size, tow_type) %>%
summarise(n_taxa = n_distinct(genus), .groups = 'drop') %>%
pivot_wider(names_from = c(tow_size,tow_type),
values_from = n_taxa)
#unique taxa per site, tow size, tow type
ays_data %>%
distinct(site, tow_size, tow_type, taxon) %>%
group_by(taxon) %>%
filter(n_distinct(tow_type) == 1 & n_distinct(tow_size) == 1) %>%
ungroup() %>%
arrange(taxon) %>%
group_by(site, tow_size,tow_type) %>%
summarise(n_taxa = n_distinct(taxon), .groups = 'drop') %>%
pivot_wider(names_from = c(tow_size,tow_type),
values_from = n_taxa)
ays_data %>%
distinct(site, tow_size, tow_type, taxon) %>%
group_by(taxon) %>%
filter(n_distinct(tow_type) == 1 & n_distinct(tow_size) == 1) %>%
ungroup() %>%
arrange(taxon) %>%
group_by(site, tow_size, tow_type) %>%
summarise(taxa = paste(unique(taxon), collapse = ", "), .groups = "drop") %>%
pivot_wider(names_from = site, values_from = taxa)
ays_data %>%
group_by(site, tow_type , tow_size) %>%
reframe(mean_aa = median(abs_abun),
sd_aa = sd(abs_abun)) %>%
select(!sd_aa) %>%
pivot_wider(names_from = c(tow_type, tow_size), values_from = mean_aa)
# Prepare data: one row per taxon × site × tow_type × tow_size
sankey_data_taxon <- ays_data %>%
distinct(site, station, tow_size,tow_type,taxon, total_cells,functional_type) %>%
unite("coll_config", tow_type,tow_size, sep = "_size")
# Plot Sankey (alluvial)
ggplot(sankey_data_taxon,
aes(axis1 = coll_config, axis2 = site,
axis3 = functional_type,
y = log1p(total_cells))) +
geom_alluvium(aes(fill = coll_config), alpha = 0.7, width = 0.35) +
geom_stratum(width = 0.25, fill = "grey80", color = "black") +
geom_text(stat = "stratum",
aes(label = after_stat(stratum)),
data = function(d) {
d %>%
dplyr::mutate(functional_type = ifelse(functional_type %in% c("Flagellate", "Silicoflagellate"), "", functional_type))
}) +
scale_x_discrete(limits = c("Collection method", "Site", "Fucntional group"),
expand = c(.05, .05)) +
scale_fill_manual(values = c("#0072B2","#E69F00","#D55E00","#009E73","purple")) +
labs(title = "",
fill = "",
y = "") +
theme_minimal() +
theme(legend.position = "top",
legend.text = element_text(size = 12, color = "black"),
axis.text = element_text(size = 12, color = "black"),
text = element_text(size = 12, color = "black"))
ggplot(sankey_data_taxon %>%
filter(functional_type %in% c("Flagellate", "Silicoflagellate")),
aes(axis1 = coll_config, axis2 = site,
axis3 = functional_type,
y = log1p(total_cells))) +
geom_alluvium(aes(fill = coll_config), alpha = 0.7, width = 0.35) +
geom_stratum(width = 0.25, fill = "grey80", color = "black") +
geom_text(stat = "stratum",
aes(label = after_stat(stratum)),
check_overlap = TRUE) +
scale_x_discrete(limits = c("Collection method", "Site", "Fucntional group"),
expand = c(.05, .05)) +
scale_fill_manual(values = c("#0072B2","#E69F00","#D55E00","#009E73","purple")) +
labs(title = "",
fill = "",
y = "") +
theme_minimal() +
theme(legend.position = "top",
legend.text = element_text(size = 12, color = "black"),
axis.text = element_text(size = 12, color = "black"),
text = element_text(size = 12, color = "black"))
ggsave(filename = "plots/Figure 1b.jpg", width = 12, height = 8, dpi = 300)
setwd("C:/Resources/Campus Work/PhD/Writing/Chapter7 -just microscope collection/code")
ggsave(filename = "plots/Figure 1b.jpg", width = 12, height = 8, dpi = 300)
##
# Absolute abundance - Figure 2a---------------------------------------
ggplot(ays_data %>%
mutate(ts_meth = paste(tow_size, tow_type, sep = "_"),
ts_meth = factor(ts_meth, levels = c("0_U", "20_H", "20_V", "55_H", "55_V"),
labels = c("Water grab",
"20µm net horizontal",
"20µm net vertical",
"55µm net horizontal",
"55µm net vertical"))),
aes(x = ts_meth, y = log10(abs_abun), fill = ts_meth)) +
geom_boxplot() +
geom_jitter(aes(color = functional_type)) +
scale_color_manual(values = c("#0072B2","#E69F00","#D55E00","#009E73")) +
scale_x_discrete(labels = wrap_labels(
c("Water grab",
"20µm net horizontal",
"20µm net vertical",
"55µm net horizontal",
"55µm net vertical"), width =12, new.line="\n"))+
scale_fill_manual(values = c("#E69F00", "#bcbd22",
"#1f77b4", "#2ca02c",
"#17becf", "#91cf60"),
name = "",
labels = c("Water grab",
"20µm net horizontal",
"20µm net vertical",
"55µm net horizontal",
"55µm net vertical")) +
facet_grid(~site,scales = "free",
labeller = labeller(site = c("AB" = "Algoa Bay",
"SHB" = "St. Helena Bay",
"WB" = "Walker Bay"))) +
labs(subtitle = "",
x = "",
y = expression(log[10]("Abs. abundance"))) +
theme(
axis.text.x = element_text(size = 12, angle = 90,vjust=0.5,hjust=0.5, color = "black"),
axis.title.x = element_blank(),
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "none",
axis.title = element_text(size = 12),
legend.key = element_rect(fill = "transparent"),
panel.grid.major.y = element_line(color = "grey75"),
legend.title = element_blank(),
strip.background = element_blank(),
strip.text = element_text(size = 12),
legend.text = element_text(size = 12),
axis.text.y = element_text(size = 12),
strip.placement = "outside",
text = element_text(family = "Arial")) +
guides(fill = "none") +
geom_signif(test =  "wilcox.test",
comparisons = list(
c( "Water grab","20µm net horizontal"),
c( "Water grab","20µm net vertical"),
c( "Water grab","55µm net horizontal"),
c( "Water grab","55µm net vertical"),
c( "20µm net vertical","20µm net horizontal"),
c( "55µm net vertical","55µm net horizontal"),
c( "20µm net horizontal","55µm net horizontal"),
c( "20µm net vertical","55µm net vertical")),
map_signif_level = TRUE, step_increase = 0.1,
y_position = 6, vjust = 0, textsize = 4) +
ggtitle("absolute abundance") -> abs_abun_kwplot1
##
# Relative abundance plot - Figure 2b ------------------------------
ays_data <- ays_data %>%
mutate(rela_abun_densi = replace_na(rela_abun_densi, 0))
range(ays_data$rela_abun_densi)
hist(log10(ays_data$rela_abun_densi))
ggplot(ays_data %>%
mutate(ts_meth = paste(tow_size, tow_type, sep = "_"),
ts_meth = factor(ts_meth, levels = c("0_U", "20_H", "20_V", "55_H", "55_V"),
labels = c("Water grab",
"20µm net horizontal",
"20µm net vertical",
"55µm net horizontal",
"55µm net vertical"))),
aes(x = ts_meth, y = log10(rela_abun_densi), fill = ts_meth)) +
geom_boxplot() +
geom_jitter(aes(color = functional_type)) +
scale_color_manual(values = c("#0072B2","#E69F00","#D55E00","#009E73")) +
scale_x_discrete(labels = wrap_labels(
c("Water grab",
"20µm net horizontal",
"20µm net vertical",
"55µm net horizontal",
"55µm net vertical"), width =12, new.line="\n"))+
scale_fill_manual(values = c("#E69F00","#bcbd22",
"#1f77b4", "#2ca02c",
"#17becf", "#91cf60"),
name = "",
labels = c("Water grab",
"20µm net horizontal",
"20µm net vertical",
"55µm net horizontal",
"55µm net vertical")) +
facet_grid(~site,scales = "free",
labeller = labeller(site = c("AB" = "Algoa Bay",
"SHB" = "St. Helena Bay",
"WB" = "Walker Bay"))) +
guides(fill = "none") +
labs(subtitle = "",
x = "",
y = expression(log[10]("Relative abundance"))) +
theme(
axis.text.x = element_text(size = 12, angle = 90,vjust=0.5,hjust=0.5, color = "black"),
axis.title.x = element_blank(),
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "none",
axis.title = element_text(size = 12),
legend.key = element_rect(fill = "transparent"),
panel.grid.minor.x = element_line(color = "black"),
legend.title = element_blank(),
strip.background = element_blank(),
strip.text = element_text(size = 12),
legend.text = element_text(size = 12),
axis.text.y = element_text(size = 12, color = "black"),
strip.placement = "outside",
text = element_text(family = "Arial")) +
geom_signif(test =  "wilcox.test",
comparisons = list(
c( "Water grab","20µm net horizontal"),
c( "Water grab","20µm net vertical"),
c( "Water grab","55µm net horizontal"),
c( "Water grab","55µm net vertical"),
c( "20µm net vertical","20µm net horizontal"),
c( "55µm net vertical","55µm net horizontal"),
c( "20µm net horizontal","55µm net horizontal"),
c( "20µm net vertical","55µm net vertical")),
map_signif_level = TRUE, step_increase = 0.1,
y_position = 3, vjust = 0, textsize = 4) +
ggtitle("relative abundance") -> rela_abun_kwplot1
kw_abun_plots <- (abs_abun_kwplot1 /  rela_abun_kwplot1) +
plot_layout(guides = "collect", axes ="collect",
ncol= 2, nrow = 1) +
plot_annotation(tag_levels = "A")
kw_abun_plots <- (abs_abun_kwplot1 /  rela_abun_kwplot1) +
plot_layout(guides = "collect", axes ="collect",
ncol= 2, nrow = 1) +
plot_annotation(tag_levels = "a")
print(kw_abun_plots)
ggsave(filename = "plots/Figure 2.jpg", width = 12, height = 8, dpi = 300)
###
# Renyi plots --------------------------------------------------
testdata_hillebrand <- ays_data %>%
filter(functional_type %in% c("Diatom", "Dinoflagellate", "Flagellate", "Silicoflagellate")) %>%
select(site,station,tow_size, tow_type,taxon,total_cells) %>%
mutate(coll_config = paste(tow_type, tow_size, sep = "_size")) %>%
arrange(taxon) %>%
pivot_wider(id_cols = c(coll_config, site),
values_fn = sum,
names_from = taxon,
values_fill = 0,
values_from = total_cells)
###
# Renyi plots --------------------------------------------------
renyidata <- ays_data %>%
filter(functional_type %in% c("Diatom", "Dinoflagellate", "Flagellate", "Silicoflagellate")) %>%
select(site,station,tow_size, tow_type,taxon,total_cells) %>%
mutate(coll_config = paste(tow_type, tow_size, sep = "_size")) %>%
arrange(taxon) %>%
pivot_wider(id_cols = c(coll_config, site),
values_fn = sum,
names_from = taxon,
values_fill = 0,
values_from = total_cells)
renyidata$S <- specnumber(renyidata[,3:ncol(renyidata)])
renyidata$ENS <- diversity(renyidata[,3:ncol(renyidata)], "invsimpson")
summary(renyidata[,c(1:2,102:103)])
renyi_methods <- renyi(renyidata[,3:ncol(renyidata)],
scales = c(0, 0.5, 1, 2, 4, 16, 32, Inf),
hill = TRUE)
renyi_methods <- renyi_methods %>% rename(S.meth="0", expH.meth="1", ENS.meth="2", BP.Ind = "Inf" )
div_renyi <- cbind(renyidata[,c("coll_config","site")], renyi_methods)
div_renyi_long <- div_renyi %>%
pivot_longer(cols = c(`0.5`, `4`, `16`, `32`, BP.Ind),
names_to = "alpha",
values_to = "renyi_index") %>%
mutate(alpha = factor(alpha, levels = c("0.5","4","16","32","BP.Ind")))
ggplot(div_renyi_long,
aes(x = as.numeric(as.character(alpha)),
y = renyi_index,
group = coll_config,
color = coll_config)) +
geom_line(size = 1) +
geom_point(size = 2) +
facet_wrap(~site, nrow = 1, labeller = labeller(site = c(
"AB" = "Algoa Bay",
"SHB" = "St Helena Bay",
"WB" = "Walker Bay"
))) +
scale_x_continuous(breaks = c(0.5, 4, 16, 32), labels = c("0.5","4","16","32")) +
scale_color_manual(values = c("#0072B2","#E69F00","#009E73", "#D55E00", "#CC79A7")) +
labs(title = "",
x = expression(alpha),
y = "Renyi diversity index",
color = "Collection method") +
theme(
axis.text.x = element_text(size = 12, angle = 0,vjust=0.5,hjust=0.5, color = "black"),
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "bottom",
axis.title = element_text(size = 12, color = "black"),
legend.key = element_rect(fill = "transparent"),
panel.grid.minor.x = element_line(color = "grey80"),
legend.title = element_text(size = 12),
strip.background = element_blank(),
strip.text = element_text(size = 12),
legend.text = element_text(size = 12),
axis.text.y = element_text(size = 12, color = "black"),
strip.placement = "outside")
library(egg)
install.packages("egg")
library(egg)
ggplot(div_renyi_long,
aes(x = as.numeric(as.character(alpha)),
y = renyi_index,
group = coll_config,
color = coll_config)) +
geom_line(size = 1) +
geom_point(size = 2) +
facet_wrap(~site, nrow = 1, labeller = labeller(site = c(
"AB" = "Algoa Bay",
"SHB" = "St Helena Bay",
"WB" = "Walker Bay"
))) +
scale_x_continuous(breaks = c(0.5, 4, 16, 32), labels = c("0.5","4","16","32")) +
scale_color_manual(values = c("#0072B2","#E69F00","#009E73", "#D55E00", "#CC79A7")) +
labs(title = "",
x = expression(alpha),
y = "Renyi diversity index",
color = "Collection method") +
theme(
axis.text.x = element_text(size = 12, angle = 0,vjust=0.5,hjust=0.5, color = "black"),
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "bottom",
axis.title = element_text(size = 12, color = "black"),
legend.key = element_rect(fill = "transparent"),
panel.grid.minor.x = element_line(color = "grey80"),
legend.title = element_text(size = 12),
strip.background = element_blank(),
strip.text = element_text(size = 12),
legend.text = element_text(size = 12),
axis.text.y = element_text(size = 12, color = "black"),
strip.placement = "outside") +
egg::tag_facet("a")
ggplot(div_renyi_long,
aes(x = as.numeric(as.character(alpha)),
y = renyi_index,
group = coll_config,
color = coll_config)) +
geom_line(size = 1) +
geom_point(size = 2) +
facet_wrap(~site, nrow = 1, labeller = labeller(site = c(
"AB" = "Algoa Bay",
"SHB" = "St Helena Bay",
"WB" = "Walker Bay"
))) +
scale_x_continuous(breaks = c(0.5, 4, 16, 32), labels = c("0.5","4","16","32")) +
scale_color_manual(values = c("#0072B2","#E69F00","#009E73", "#D55E00", "#CC79A7")) +
labs(title = "",
x = expression(alpha),
y = "Renyi diversity index",
color = "Collection method") +
theme(
axis.text.x = element_text(size = 12, angle = 0,vjust=0.5,hjust=0.5, color = "black"),
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "bottom",
axis.title = element_text(size = 12, color = "black"),
legend.key = element_rect(fill = "transparent"),
panel.grid.minor.x = element_line(color = "grey80"),
legend.title = element_text(size = 12),
strip.background = element_blank(),
strip.text = element_text(size = 12),
legend.text = element_text(size = 12),
axis.text.y = element_text(size = 12, color = "black"),
strip.placement = "outside")
egg::tag_facet("a")
ggplot(div_renyi_long,
aes(x = as.numeric(as.character(alpha)),
y = renyi_index,
group = coll_config,
color = coll_config)) +
geom_line(size = 1) +
geom_point(size = 2) +
facet_wrap(~site, nrow = 1, labeller = labeller(site = c(
"AB" = "Algoa Bay",
"SHB" = "St Helena Bay",
"WB" = "Walker Bay"
))) +
scale_x_continuous(breaks = c(0.5, 4, 16, 32), labels = c("0.5","4","16","32")) +
scale_color_manual(values = c("#0072B2","#E69F00","#009E73", "#D55E00", "#CC79A7")) +
labs(title = "",
x = expression(alpha),
y = "Renyi diversity index",
color = "Collection method") +
theme(
axis.text.x = element_text(size = 12, angle = 0,vjust=0.5,hjust=0.5, color = "black"),
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "bottom",
axis.title = element_text(size = 12, color = "black"),
legend.key = element_rect(fill = "transparent"),
panel.grid.minor.x = element_line(color = "grey80"),
legend.title = element_text(size = 12),
strip.background = element_blank(),
strip.text = element_text(size = 12),
legend.text = element_text(size = 12),
axis.text.y = element_text(size = 12, color = "black"),
strip.placement = "outside")->p
egg::tag_facet(p)
ggplot(div_renyi_long,
aes(x = as.numeric(as.character(alpha)),
y = renyi_index,
group = coll_config,
color = coll_config)) +
geom_line(size = 1) +
geom_point(size = 2) +
facet_wrap(~site, nrow = 1, labeller = labeller(site = c(
"AB" = "Algoa Bay",
"SHB" = "St Helena Bay",
"WB" = "Walker Bay"
))) +
scale_x_continuous(breaks = c(0.5, 4, 16, 32), labels = c("0.5","4","16","32")) +
scale_color_manual(values = c("#0072B2","#E69F00","#009E73", "#D55E00", "#CC79A7")) +
labs(title = "",
x = expression(alpha),
y = "Renyi diversity index",
color = "Collection method") +
theme(
axis.text.x = element_text(size = 12, angle = 0,vjust=0.5,hjust=0.5, color = "black"),
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "bottom",
axis.title = element_text(size = 12, color = "black"),
legend.key = element_rect(fill = "transparent"),
panel.grid.minor.x = element_line(color = "grey80"),
legend.title = element_text(size = 12),
strip.background = element_blank(),
strip.text = element_text(size = 12),
legend.text = element_text(size = 12),
axis.text.y = element_text(size = 12, color = "black"),
strip.placement = "outside")
ggsave(filename = "plots/Figure 3.jpg", width = 12, height = 8, dpi = 300)
# Step 1: Build community matrix (samples = site × coll_config, columns = taxa)
comm_matrix <- ays_data %>%
group_by(site,station, tow_size, tow_type, taxon) %>%
summarise(abundance = sum(abs_abun), .groups = "drop") %>%
mutate(coll_config = paste(tow_type, tow_size, sep = "_")) %>%
select(coll_config, site,station, tow_size, tow_type, taxon, abundance) %>%
pivot_wider(names_from = taxon, values_from = abundance, values_fill = 0)
# Save metadata
metadata <- comm_matrix %>%
select(coll_config, site,station, tow_size, tow_type)
# Drop non-taxa cols for the matrix
comm_only <- comm_matrix %>%
select(-coll_config, -site,-station, -tow_size, -tow_type)
# Bray-Curtis dissimilarity
dist_mat <- vegdist(comm_only, method = "bray")
# PERMANOVA
adonis_result <- adonis2(dist_mat ~ coll_config * site,
data = metadata, permutations = 999)
print(adonis_result)
dispersion_methods <- betadisper(dist_mat, metadata$coll_config)
anova(dispersion_methods)
dispersion <- betadisper(dist_mat, metadata$site)
anova(dispersion)
# Extract distances from betadisper object
disp_df <- data.frame(
coll_config = metadata$site,
distance = dispersion$distances
)
ggplot(disp_df, aes(x = coll_config, y = distance, fill = coll_config)) +
geom_boxplot(alpha = 0.7) +
geom_jitter(width = 0.1, alpha = 0.5) +
labs(x = "Collection method", y = "Distance to centroid",
title = "Multivariate dispersion by collection method") +
theme_minimal(base_size = 13) +
theme(legend.position = "none")
# Run NMDS (2D)
nmds <- metaMDS(comm_only, distance = "bray", k = 2, trymax = 100)
nmds_scores <- as.data.frame(scores(nmds, display = "sites")) %>%
bind_cols(metadata)
stress_val <- round(nmds$stress, 3)
ggplot(nmds_scores, aes(x = NMDS1, y = NMDS2,
color = site , shape = coll_config)) +
geom_point(size = 3, alpha = 0.8) +
stat_ellipse(aes(group = site), color = "black", linetype = "dashed") +
scale_color_manual(values = c("#0072B2","#E69F00","#009E73", "#D55E00", "#CC79A7")) +
labs(title = "",
color = "", shape = "Collection method") +
theme(
axis.text.x = element_text(size = 12, angle = 0,vjust=0.5,hjust=0.5, color = "black"),
panel.background = element_rect(fill = "white"),
panel.grid.major = element_line(color = "grey80"),
legend.position = "bottom",
axis.title = element_text(size = 12, color = "black"),
legend.key = element_rect(fill = "transparent"),
panel.grid.minor.x = element_line(color = "grey80"),
legend.title = element_text(size = 12),
strip.background = element_blank(),
strip.text = element_text(size = 12),
legend.text = element_text(size = 12),
axis.text.y = element_text(size = 12, color = "black"),
strip.placement = "outside") +
annotate("text",
x = 1.6,
y = -2,
label = paste("Stress =", stress_val),
size = 4)
ggsave(filename = "plots/Figure 4.jpg", width = 12, height = 8, dpi = 300)
system("git -- version")
system("git --version")
source("C:/Resources/Campus Work/PhD/Writing/Chapter7 -just microscope collection/code/code_paper.R", echo=TRUE)
